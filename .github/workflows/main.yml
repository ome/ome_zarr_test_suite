---
name: Build

on:
  repository_dispatch:
    types: [run_test_suite]
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ms_suite: omero-ms-zarr-suite
      bf_suite: ome-zarr-bf2raw-suite
      zarr_suite: ome-zarr-py-suite
    steps:
      - uses: actions/checkout@v2
      - name: Setup miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          channels: conda-forge,ome
          environment-file: environment.yml
          python-version: 3.9
      - name: Set testing environment
        if: github.event.action == 'run_test_suite'
        shell: bash
        run: |
          # Set the parameters to be used in the response
          repo=${{ github.event.client_payload.repo }}
          owner=${{ github.event.client_payload.owner }}
          sha=${{ github.event.client_payload.sha }}
          repo_name=${repo#"$owner"}
          repo_name=${repo_name#"/"}
          echo "client_repo_name="$repo_name >> $GITHUB_ENV
          echo "client_sha="$sha >> $GITHUB_ENV
          ./setup.sh $repo
      - name: Run pytest
        shell: bash -l {0}
        run: pytest -vxk "not omero"
